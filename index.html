<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MEMEMATCH</title>
  <!-- Favicon and web icon for browser tabs and devices -->
  <link rel="icon" href="UI_images/icons8-meme-96.png" sizes="96x96" type="image/png">
  <link rel="icon" href="UI_images/icons8-meme-48.png" sizes="48x48" type="image/png">
  <link rel="apple-touch-icon" href="/UI_images/apple-touch-icon.png" sizes="180x180">
  <style>
    :root {
      --primary: #4a90e2;
      --secondary: #f4f4f9;
      --text: #333;
      --card-bg: #fff;
      --radius: 8px;
      --gap: 16px;
      --transition: 0.3s ease;
    }
    [data-theme="dark"] {
      --primary: #5a9bd5;
      --secondary: #1e1e1e;
      --text: #eeeeee;
      --card-bg: #2a2a2a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--secondary);
      color: var(--text);
      display: flex; flex-direction: column;
      align-items: center;
      padding: var(--gap);
      min-height: 100vh;
    }
    header {
      text-align: center;
      padding: var(--gap) 0;
      margin-bottom: var(--gap * 1.5);
    }
    /* Wrap logo and title */
    .header-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--gap);
    }
    .logo {
      width: 48px;
      height: auto;
    }
    header h1 {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-weight: 300;
      font-size: 2.75rem;
      letter-spacing: 0.05em;
      color: var(--text);
    }
    header p {
      margin-top: 0.5rem;
      font-size: 1rem;
      font-weight: 300;
      color: #555;
    }
    #resultsContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 1000px;
      margin: var(--gap) auto;
    }
    #formContainer {
      width: 100%;
      max-width: 600px;
      background: var(--card-bg);
      padding: var(--gap);
      margin: var(--gap) auto var(--gap) auto;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #formContainer h2 {
      margin-bottom: var(--gap);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-weight: 300;
      font-size: 1.25rem;
      color: var(--text);
      text-align: center;
    }
    #memeForm {
      display: flex;
      gap: var(--gap);
    }
    #query {
      flex: 1;
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid #ccc;
      border-radius: var(--radius);
      transition: border-color var(--transition);
    }
    #query:focus { border-color: var(--primary); outline: none; }
    button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0 24px;
      border-radius: var(--radius);
      font-size: 1rem;
      cursor: pointer;
      transition: background var(--transition);
    }
    button:disabled { background: #aaccee; cursor: not-allowed; }
    button:hover:not(:disabled) { background: #357ab8; }

    #loader {
      display: none;
      margin: var(--gap) auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Main results section styling */
    #resultsSection {
      width: 100%;
      max-width: 1000px;
      margin: var(--gap) auto;
      padding: 0 var(--gap);
    }
    /* Shared grid for results */
    #results, #uploadResults {
      width: 100%;
      max-width: 1000px;
      display: grid;
      grid-template-columns: repeat(3, minmax(250px, 1fr));
      gap: var(--gap);
      justify-content: center;
      padding: 0;
    }
    .meme-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform var(--transition);
      position: relative;
    }
    .meme-card:hover { transform: translateY(-4px); }
    .option-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 36px;
      height: 36px;
      background: var(--card-bg);
      border: none;
      border-radius: 50% !important;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: var(--text);
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition), color var(--transition);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      overflow: hidden;
      padding: 0;
    }
    .option-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      background: var(--primary);
      color: #fff;
    }
    .option-dropdown {
      position: absolute;
      top: 40px;
      right: 8px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.13);
      z-index: 2;
      min-width: 140px;
      overflow: hidden;
      visibility: hidden;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity var(--transition), transform var(--transition), visibility var(--transition);
    }
    .option-dropdown.show {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
    }
    .option-dropdown a {
      padding: 12px 18px;
      font-size: 1.05rem;
      text-decoration: none;
      color: var(--text);
      transition: background var(--transition), color var(--transition);
      display: block;
      text-align: left;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    .option-dropdown a:hover, .option-dropdown a:focus {
      background: #f2f2f7;
      color: #007aff;
    }
    .meme-card img {
      width: 100%;
      object-fit: cover;
      aspect-ratio: 1;
    }
    .meme-card code {
      padding: var(--gap);
      font-size: 0.9rem;
      color: var(--text);
      word-wrap: break-word;
    }
    .no-memes {
      grid-column: 1/-1;
      text-align: center;
      font-size: 1.2rem;
      color: #e74c3c;
    }

    /* Modal backdrop and content styles */
    #modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
    }
    #modal img {
      max-width: 90%;
      max-height: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    #modal .close {
      position: absolute;
      top: 20px; right: 30px;
      color: #fff;
      font-size: 2rem;
      cursor: pointer;
    }

    /* Dark mode theme variables and switch styles */
    .theme-switch-wrapper {
      position: absolute;
      top: var(--gap);
      right: var(--gap);
      display: flex;
      align-items: center;
    }
    .theme-switch {
      display: inline-block;
      width: 50px;
      height: 24px;
      position: relative;
    }
    .theme-switch input {
      display: none;
    }
    .theme-switch .slider {
      background: #ccc;
      border-radius: 34px;
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      transition: background .4s;
    }
    .theme-switch .slider:before {
      content: "";
      position: absolute;
      width: 20px; height: 20px;
      left: 2px; bottom: 2px;
      background: #fff;
      border-radius: 50%;
      transition: transform .4s;
    }
    .theme-switch input:checked + .slider {
      background: #666;
    }
    .theme-switch input:checked + .slider:before {
      transform: translateX(26px);
    }
    .switch-label {
      margin-right: 8px;
      font-size: 0.9rem;
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* History section styling */
    #historyContainer {
      width: 100%; max-width: 1000px;
      margin: var(--gap) auto;
    }
    #historyContainer h2 {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-weight: 300;
      font-size: 1.5rem;
      color: var(--text);
      margin-bottom: var(--gap);
      margin-top: var(--gap);
    }
    #clearHistoryBtn {
      display: inline-block;
      margin-bottom: calc(var(--gap) * 1.5);
    }
    #historyList {
      display: flex;
      flex-direction: column;
      gap: var(--gap);
      list-style: none;
      padding: 0;
    }
    #historyList .meme-card code {
      padding: var(--gap);
      font-size: 0.9rem;
      color: var(--text);
      word-wrap: break-word;
    }
    /* Delete button for history items */
    .delete-btn { background: transparent; border: none; color: #e74c3c; font-size: 1rem; cursor: pointer; margin-left: auto; }
    /* Flex container for history items */
    .history-item { display: flex; align-items: center; }

    /* Dim overlay */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition), visibility var(--transition);
      z-index: 1000;
    }
    #overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    /* Menu drawer */
    #menu {
      position: fixed;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100%;
      background: var(--card-bg);
      transition: left var(--transition);
      box-shadow: 2px 0 12px rgba(0,0,0,0.1);
      /* bring menu above most content */
      z-index: 2000;
    }
    #menu.open {
      left: 0;
      transform: none !important;
    }

    .hidden { display: none !important; }
    .menu-wrapper { position: absolute; top: var(--gap); left: var(--gap); z-index: 1002; }
    #menu .menu-item { padding: 8px 16px; cursor: pointer; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    #menu .menu-item:hover { background: var(--secondary); }

    /* Toast notification */
    #toast {
      position: fixed;
      bottom: var(--gap);
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: var(--card-bg);
      padding: 8px 16px;
      border-radius: var(--radius);
      opacity: 0;
      transition: opacity var(--transition);
      pointer-events: none;
      z-index: 2002;
    }

    /* About section modern styling */
    #aboutContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: var(--card-bg);
      padding: var(--gap);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: var(--gap) auto;
      text-align: center;
    }
    #aboutContainer .about-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--gap);
    }
    @media (min-width: 600px) {
      #aboutContainer .about-content {
        flex-direction: row;
        text-align: left;
      }
    }
    #aboutContainer .profile-img img {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
    }
    #aboutContainer .profile-info .name {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    #aboutContainer .profile-info .contact a {
      color: var(--primary);
      text-decoration: none;
      transition: color var(--transition);
    }
    #aboutContainer .profile-info .contact a:hover {
      color: #357ab8;
    }
    #aboutContainer .app-meta {
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid rgba(0,0,0,0.1);
      text-align: left;
      padding-left: 16px;
      font-size: 0.9rem;
      color: #888;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      width: 100%;
    }
    @media (max-width: 600px) {
      #aboutContainer .app-meta {
        text-align: center;
        padding-left: 0;
      }
    }
    [data-theme="dark"] #aboutContainer .app-meta {
      border-top-color: rgba(255,255,255,0.1);
      color: #aaa;
    }

    #aboutContainer .app-meta p {
      margin: 4px 0;
    }

    /* Filter button and dropdown */
    .filter-wrapper {
      position: relative;
      margin-left: var(--gap);
      margin-top: var(--gap);
      display: inline-block;
    }
    .filter-btn {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid #ccc;
      padding: 8px 12px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background var(--transition), box-shadow var(--transition);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .filter-btn:hover {
      background: var(--primary);
      color: #fff;
    }
    .filter-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      visibility: hidden;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity var(--transition), transform var(--transition), visibility var(--transition);
      z-index: 3;
    }
    .filter-dropdown.show {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
    }
    .filter-section {
      padding: 8px 12px;
    }
    .filter-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .filter-dropdown a {
      display: inline-block;
      margin: 4px 4px 0 0;
      padding: 4px 8px;
      border-radius: var(--radius);
      text-decoration: none;
      color: var(--text);
      transition: background var(--transition);
    }
    .filter-dropdown a.selected,
    .filter-dropdown a:hover {
      background: var(--primary);
      color: #fff;
    }

    /* Upload panel styling */
    #uploadContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      width: 100%;
      max-width: 600px;
      margin: var(--gap) auto;
      background: var(--card-bg);
      padding: var(--gap) var(--gap) 8px var(--gap);  /* smaller bottom padding */
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #uploadForm {
      display: flex;
      flex-wrap: wrap;
      gap: var(--gap);
      justify-content: center;
      align-items: center;
      margin-bottom: 4px;  /* smaller space below Find Similar */
    }
    #uploadResults {
      /* force 3 columns for upload results */
      grid-template-columns: repeat(3, minmax(250px, 1fr));
    }
    /* Modern dropdown styling for meme count selection */
    .dropdown-wrapper {
      position: relative;
      display: inline-block;
      margin-top: var(--gap);
    }

    .dropdown-btn {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid #ccc;
      padding: 8px 12px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      transition: background var(--transition), box-shadow var(--transition);
      display: flex;
      gap: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      width: 100%; /* Match the width of the dropdown menu in the "Give your request" panel */
      max-width: 600px; /* Ensure it doesn't exceed the panel's max width */
    }

    .dropdown-btn:hover {
      background: var(--primary);
      color: #fff;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      visibility: hidden;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity var(--transition), transform var(--transition), visibility var(--transition);
      z-index: 10;
      min-width: 100%; /* Match the width of the dropdown button */
      max-width: 600px; /* Ensure it doesn't exceed the panel's max width */
    }

    .dropdown-menu.show {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
    }

    .dropdown-menu a {
      display: block;
      padding: 8px 12px;
      text-decoration: none;
      color: var(--text);
      font-size: 1rem;
      transition: background var(--transition), color var(--transition);
    }

    .dropdown-menu a:hover {
      background: var(--primary);
      color: #fff;
    }

    .dropdown-menu a.selected {
      background: var(--primary);
    }

    /* Modern pill-shaped gradient ‘Find Similar’ button */
    #uploadForm button[type="submit"] {
      background: linear-gradient(135deg, var(--primary) 0%, #357ab8 100%);
      color: #fff;
      padding: 14px 20px;
      border: none;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
      max-width: 360px;
      margin: var(--gap) 0 0 0;
    }
    #uploadForm button[type="submit"]:hover:not(:disabled) {
      background: linear-gradient(135deg, #357ab8 0%, var(--primary) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    #uploadForm button[type="submit"]:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #uploadForm button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      background: linear-gradient(135deg, var(--primary) 0%, #357ab8 100%);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <img src="UI_images/icons8-meme-96.png" alt="MEMEMATCH Logo" class="logo">
      <h1>MEMEMATCH</h1>
    </div>
    <p>Your AI Meme Recommendation Assistant. Just type and enjoy.</p>
    <div class="theme-switch-wrapper">
      <span class="switch-label">Dark Mode</span>
      <label class="theme-switch">
        <input type="checkbox" id="theme-toggle">
        <span class="slider"></span>
      </label>
    </div>
    <div class="menu-wrapper">
      <button id="menu-toggle" aria-label="Menu">☰</button>
    </div>
  </header>

  <section id="resultsContainer">
    <section id="formContainer" aria-labelledby="formTitle">
      <h2 id="formTitle">Enter your meme request here</h2>
      <form id="memeForm">
        <input
          type="text"
          id="query"
          placeholder="e.g. 'Gimme a sarcastic Zoom fatigue meme'"
          aria-label="Your meme request"
          required
        >
        <button type="submit">Get Memes</button>
        <input type="hidden" id="topN" name="top_n" value="10">
        <input type="hidden" id="topNTemplate" name="top_n_template" value="5">
      </form>
      <div class="filter-wrapper">
        <button type="button" class="filter-btn" id="filterBtn">Memes: 10, Templates: 5 ▾</button>
        <div class="filter-dropdown" id="filterDropdown">
          <div class="filter-section">
            <div class="filter-title">Memes</div>
            <a href="#" data-type="memes" data-value="10" class="selected">10</a>
            <a href="#" data-type="memes" data-value="20">20</a>
            <a href="#" data-type="memes" data-value="50">50</a>
          </div>
          <div class="filter-section">
            <div class="filter-title">Templates</div>
            <a href="#" data-type="templates" data-value="5" class="selected">5</a>
            <a href="#" data-type="templates" data-value="10">10</a>
            <a href="#" data-type="templates" data-value="20">20</a>
          </div>
        </div>
      </div>
      <div id="loader" role="status" aria-label="Loading"></div>
    </section>  <!-- end of #resultsContainer -->

    <!-- Main search results split into its own section -->
    <section id="resultsSection">
      <ul id="results" aria-live="polite"></ul>
    </section>
  </section>

  <!-- History section -->
  <section id="historyContainer" class="hidden">
    <h2>History</h2>
    <button id="clearHistoryBtn">Clear All</button>
    <ul id="historyList" aria-live="polite"></ul>
  </section>

  <!-- About section -->
  <section id="aboutContainer" class="hidden">
    <h2>About</h2>
    <div class="about-content">
      <div class="profile-img">
        <img src="/UI_images/Tri%20An%20headshot.png" alt="Tri An Le">
      </div>
      <div class="profile-info">
        <p class="name">Tri An Le</p>
        <p class="role">Data Science & AI Enthusiast</p>
        <div class="contact">
          <p>Email: <a href="mailto:triandole@gmail.com">triandole@gmail.com</a></p>
          <p>Contact: <a href="tel:+1 (765) 350 9132">+1 765 350 9132</a></p>
          <p>LinkedIn: <a href="https://www.linkedin.com/in/trianle/" target="_blank">https://www.linkedin.com/in/trianle/</a></p>
        </div>
      </div>
    </div>
    <div class="app-meta">
      <p class="version">Version 1.0.0</p>
      <p class="created">Created: April 2025</p>
      <p class="copyright">© 2025 MEMEMATCH. All rights reserved.</p>
    </div>
  </section>

  <!-- Upload section for image-based search -->
  <section id="uploadContainer" class="hidden">
    <h2>Upload Meme</h2>
    <form id="uploadForm">
      <label><input type="radio" name="context" value="local" checked> Local Context</label>
      <label><input type="radio" name="context" value="global"> Global Context</label>
      <input type="file" id="uploadFile" name="file" accept="image/*" required>
      <button type="submit">Find Similar</button>
      <!-- Upload results count selector -->
      <input type="hidden" id="uploadTopN" name="top_n" value="10">
      <div class="dropdown-wrapper">
        <button type="button" class="dropdown-btn" id="uploadDropdownBtn">Memes: 10 ▾</button>
        <div class="dropdown-menu" id="uploadDropdownMenu">
          <a href="#" data-value="10" class="selected">10</a>
          <a href="#" data-value="20">20</a>
          <a href="#" data-value="50">50</a>
        </div>
      </div>
    </form>
    <div id="uploadLoader" style="display:none; margin: var(--gap) auto;" role="status" aria-label="Loading">
      <div style="border:4px solid #f3f3f3; border-top:4px solid var(--primary); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;"></div>
    </div>
  </section>
  <!-- Upload results in its own section -->
  <section id="uploadResultsSection" class="hidden">
    <ul id="uploadResults" aria-live="polite"></ul>
  </section>

  <!-- Modal container for full-size display -->
  <div id="modal">
    <span class="close" aria-label="Close">&times;</span>
    <img id="modal-img" alt="Full-size meme">
  </div>

  <!-- Overlay for menu -->
  <div id="overlay"></div>

  <!-- Menu drawer -->
  <div id="menu">
    <div class="menu-item" data-section="results">Give Your Request</div>
    <div class="menu-item" data-section="upload">Find Similar Memes</div>
    <div class="menu-item" data-section="history">History</div>
    <div class="menu-item" data-section="about">About</div>
  </div>

  <!-- Toast for copy feedback -->
  <div id="toast"></div>

  <script>
    // track whether the latest results are templates or memes
    let currentNeedTemplate = null;

    // Utility: get and set JSON in localStorage
    function loadStorage(key) {
      try { return JSON.parse(localStorage.getItem(key)) || []; } catch { return []; }
    }
    function saveStorage(key, arr) {
      localStorage.setItem(key, JSON.stringify(arr));
    }

    // Toast feedback function
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.opacity = '1';
      setTimeout(() => { toast.style.opacity = '0'; }, 2000);
    }

    // Render history items
    function renderHistory() {
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      const items = loadStorage('meme_history');
      if (items.length === 0) {
        list.innerHTML = '<li class="no-memes">No history yet.</li>';
        return;
      }
      items.forEach(q => {
        const li = document.createElement('li');
        li.className = 'meme-card';
        li.innerHTML = `
          <div class="history-item">
            <code>${q}</code>
            <button class="delete-btn" aria-label="Delete history item">-</button>
          </div>`;
        // copy on code click
        li.querySelector('code').addEventListener('click', () => {
          navigator.clipboard.writeText(q)
            .then(() => showToast('Copied!'))
            .catch(() => showToast('Copy failed'));
        });
        // delete individual item
        li.querySelector('.delete-btn').addEventListener('click', e => {
          e.stopPropagation();
          deleteHistoryItem(q);
        });
        list.appendChild(li);
      });
    }

    // Delete a single history item
    function deleteHistoryItem(q) {
      const items = loadStorage('meme_history').filter(x => x !== q);
      saveStorage('meme_history', items);
      renderHistory();
      showToast('Removed');
    }

    // Clear all history
    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      saveStorage('meme_history', []);
      renderHistory();
      showToast('History cleared');
    });

    // Update history on new query
    function updateHistory(q) {
      let items = loadStorage('meme_history');
      items = [q, ...items.filter(x => x !== q)].slice(0, 20);
      saveStorage('meme_history', items);
      renderHistory();
    }

    const form = document.getElementById('memeForm');
    const results = document.getElementById('results');
    const loader = document.getElementById('loader');
    const button = form.querySelector('button');
    const formContainer = document.getElementById('formContainer');
    const resultsList = document.getElementById('results');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      results.innerHTML = '';
      button.disabled = true;
      loader.style.display = 'block';

      try {
        const resp = await fetch('/recommend', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            query: document.getElementById('query').value,
            top_n: Number(document.getElementById('topN').value),
            top_n_template: Number(document.getElementById('topNTemplate').value)
          })
        });
        const data = await resp.json();

        // remember if server returned templates or memes
        currentNeedTemplate = data.need_template;

        if (data.memes && data.memes.length) {
          data.memes.forEach(src => {
            const card = document.createElement('li');
            card.className = 'meme-card';
            card.innerHTML = `
              <img src="${src}" alt="Meme image">
              <code>${src.split('/').pop()}</code>
              <button class="option-btn" aria-label="Options">⋯</button>
              <div class="option-dropdown">
                <a href="#" class="copy-meme">Copy</a>
                <a href="#" class="save-meme">Save to device</a>
              </div>
            `;
            // open modal on card click (but not when clicking option button or dropdown)
            card.addEventListener('click', (e) => {
              // Prevent modal if option button or dropdown is clicked
              if (
                e.target.classList.contains('option-btn') ||
                e.target.closest('.option-dropdown')
              ) return;
              const modal = document.getElementById('modal');
              const modalImg = document.getElementById('modal-img');
              modalImg.src = src;
              modal.style.display = 'flex';
            });

            results.appendChild(card);
            // Option button dropdown logic
            const optionBtn = card.querySelector('.option-btn');
            const dropdown = card.querySelector('.option-dropdown');
            optionBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              dropdown.classList.toggle('show');
            });
            document.addEventListener('click', () => {
              dropdown.classList.remove('show');
            });

            // Copy meme functionality
            card.querySelector('.copy-meme').addEventListener('click', (e) => {
              e.preventDefault();
              const img = new Image();
              img.crossOrigin = 'anonymous';
              img.src = src;
              img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                canvas.toBlob((blob) => {
                  const item = new ClipboardItem({ 'image/png': blob });
                  navigator.clipboard.write([item])
                    .then(() => showToast('Copied to clipboard'))
                    .catch(() => showToast('Copy failed'));
                }, 'image/png');
              };
              img.onerror = () => showToast('Copy failed');
            });

            // Save meme functionality
            card.querySelector('.save-meme').addEventListener('click', (e) => {
              e.preventDefault();
              const a = document.createElement('a');
              a.href = src;
              a.download = src.split('/').pop();
              a.click();
            });
          });
        } else {
          results.innerHTML = '<li class="no-memes">No memes found.</li>';
        }
        updateHistory(document.getElementById('query').value);
      } catch (err) {
        results.innerHTML = '<li class="no-memes">Oops! Something went wrong.</li>';
      } finally {
        loader.style.display = 'none';
        button.disabled = false;
      }
    });

    // Menu toggle and section navigation
    const menuToggle = document.getElementById('menu-toggle');
    const menu = document.getElementById('menu');
    const overlay = document.getElementById('overlay');
    const sections = {
      resultsForm: document.getElementById('formContainer'),
      resultsResults: document.getElementById('resultsSection'),
      history: document.getElementById('historyContainer'),
      about: document.getElementById('aboutContainer'),
      uploadForm: document.getElementById('uploadContainer'),
      uploadResults: document.getElementById('uploadResultsSection')
    };
    // Toggle menu display
    menuToggle.addEventListener('click', e => {
      e.stopPropagation();
      menu.classList.add('open');
      overlay.classList.add('visible');
    });
    // Close menu clicking outside
    overlay.addEventListener('click', () => {
      menu.classList.remove('open');
      overlay.classList.remove('visible');
    });
    // Replace manual section toggling with unified logic
    document.querySelectorAll('#menu .menu-item').forEach(item => {
      item.addEventListener('click', e => {
        e.stopPropagation();
        const key = e.target.getAttribute('data-section');
        // Hide all sections
        Object.values(sections).forEach(sec => sec.classList.add('hidden'));
        // Show form and results for the selected tab
        if (key === 'results') {
          sections.resultsForm.classList.remove('hidden');
          sections.resultsResults.classList.remove('hidden');
        } else if (key === 'upload') {
          sections.uploadForm.classList.remove('hidden');
          sections.uploadResults.classList.remove('hidden');
        } else if (key === 'history' || key === 'about') {
          sections[key].classList.remove('hidden');
        }
        // Close menu and overlay
        menu.classList.remove('open');
        overlay.classList.remove('visible');
      });
    });

    // Handle image upload form
    const uploadForm = document.getElementById('uploadForm');
    uploadForm.addEventListener('submit', async e => {
      e.preventDefault();
      const uploadResults = document.getElementById('uploadResults');
      const uploadLoader = document.getElementById('uploadLoader');
      const uploadButton = uploadForm.querySelector('button');
      uploadResults.innerHTML = '';
      uploadButton.disabled = true;
      uploadLoader.style.display = 'block';
      try {
        const formData = new FormData(uploadForm);
        const topNVal = document.getElementById('uploadTopN').value;
        formData.set('top_n', topNVal);

        const resp = await fetch('/recommend/upload', { method: 'POST', body: formData });
        const data = await resp.json();
        if (data.memes && data.memes.length) {
          data.memes.forEach(src => {
            const card = document.createElement('li');
            card.className = 'meme-card';
            card.innerHTML = `
              <img src="${src}" alt="Meme image">
              <code>${src.split('/').pop()}</code>
              <button class="option-btn" aria-label="Options">⋯</button>
              <div class="option-dropdown">
                <a href="#" class="copy-meme">Copy</a>
                <a href="#" class="save-meme">Save to device</a>
              </div>
            `;
            // open modal on upload card click
            card.addEventListener('click', e => {
              if (
                e.target.classList.contains('option-btn') ||
                e.target.closest('.option-dropdown')
              ) return;
              const modal = document.getElementById('modal');
              const modalImg = document.getElementById('modal-img');
              modalImg.src = src;
              modal.style.display = 'flex';
            });

            uploadResults.appendChild(card);
            // Option button dropdown logic
            const optionBtn = card.querySelector('.option-btn');
            const dropdown = card.querySelector('.option-dropdown');
            optionBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              dropdown.classList.toggle('show');
            });
            document.addEventListener('click', () => {
              dropdown.classList.remove('show');
            });

            // Copy meme functionality
            card.querySelector('.copy-meme').addEventListener('click', (e) => {
              e.preventDefault();
              const img = new Image();
              img.crossOrigin = 'anonymous';
              img.src = src;
              img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                canvas.toBlob((blob) => {
                  const item = new ClipboardItem({ 'image/png': blob });
                  navigator.clipboard.write([item])
                    .then(() => showToast('Copied to clipboard'))
                    .catch(() => showToast('Copy failed'));
                }, 'image/png');
              };
              img.onerror = () => showToast('Copy failed');
            });

            // Save meme functionality
            card.querySelector('.save-meme').addEventListener('click', (e) => {
              e.preventDefault();
              const a = document.createElement('a');
              a.href = src;
              a.download = src.split('/').pop();
              a.click();
            });
          });
        } else {
          uploadResults.innerHTML = '<li class="no-memes">No memes found.</li>';
        }
      } catch (err) {
        uploadResults.innerHTML = '<li class="no-memes">Oops! Something went wrong.</li>';
      } finally {
        uploadLoader.style.display = 'none';
        uploadButton.disabled = false;
      }
    });

    // add modal close behavior
    const modal = document.getElementById('modal');
    modal.querySelector('.close').addEventListener('click', () => {
      modal.style.display = 'none';
    });
    modal.addEventListener('click', e => {
      if (e.target === modal) modal.style.display = 'none';
    });

    // Theme toggle logic
    const toggle = document.getElementById('theme-toggle');
    // apply saved theme or default to light
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    toggle.checked = savedTheme === 'dark';
    toggle.addEventListener('change', () => {
      const theme = toggle.checked ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
    });

    // Filter dropdown logic
    const filterBtn = document.getElementById('filterBtn');
    const filterDropdown = document.getElementById('filterDropdown');
    filterBtn.addEventListener('click', e => {
      e.stopPropagation();
      filterDropdown.classList.toggle('show');
    });
    document.addEventListener('click', () => {
      filterDropdown.classList.remove('show');
    });
    filterDropdown.querySelectorAll('a').forEach(item => {
      item.addEventListener('click', e => {
        e.preventDefault();
        const type = item.getAttribute('data-type');
        const value = item.getAttribute('data-value');
        // update UI selection
        filterDropdown.querySelectorAll(`a[data-type="${type}"]`).forEach(x => x.classList.remove('selected'));
        item.classList.add('selected');
        // update hidden inputs
        if (type === 'memes') {
          document.getElementById('topN').value = value;
        } else {
          document.getElementById('topNTemplate').value = value;
        }
        // update button label showing both counts
        const memesValue = document.getElementById('topN').value;
        const templatesValue = document.getElementById('topNTemplate').value;
        filterBtn.textContent = `Memes: ${memesValue}, Templates: ${templatesValue} ▾`;
        // auto-refresh only if changing the active result type
        const shouldRefresh = currentNeedTemplate === null ||
          (type === 'memes' && !currentNeedTemplate) ||
          (type === 'templates' && currentNeedTemplate);
        if (shouldRefresh) {
          if (typeof form.requestSubmit === 'function') {
            form.requestSubmit();
          } else {
            form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
          }
        }
      });
    });

    // Upload panel dropdown logic using modern dropdown design
    const uploadFilterBtn = document.getElementById('uploadDropdownBtn');
    const uploadFilterDropdown = document.getElementById('uploadDropdownMenu');
    uploadFilterBtn.addEventListener('click', e => { e.stopPropagation(); uploadFilterDropdown.classList.toggle('show'); });
    document.addEventListener('click', () => { uploadFilterDropdown.classList.remove('show'); });
    uploadFilterDropdown.querySelectorAll('a').forEach(item => {
      item.addEventListener('click', e => {
        e.preventDefault();
        // ...existing selection and hidden input updates...
        const val = item.getAttribute('data-value');
        document.getElementById('uploadTopN').value = val;
        uploadFilterBtn.textContent = `Memes: ${val} ▾`;
        // auto-refresh upload results on filter change
        if (typeof uploadForm.requestSubmit === 'function') {
          uploadForm.requestSubmit();
        } else {
          uploadForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        }
      });
    });
  </script>
</body>
</html>